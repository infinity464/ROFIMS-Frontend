@if (config) {
  @if (showCard) {
  <p-fluid>
    <div class="card my-0 py-0">
      <ng-container *ngTemplateOutlet="addressContent"></ng-container>
    </div>
  </p-fluid>
  } @else {
    <ng-container *ngTemplateOutlet="addressContent"></ng-container>
  }
}

<ng-template #addressContent>
  <form [formGroup]="addressForm">
    <!-- Header -->
    <div class="mb-2">
      <div class="flex align-items-center gap-3 mb-2">
        <h3 class="m-0 text-xl font-bold text-900">{{ formTitle }}</h3>
      </div>

      <!-- Same as Permanent Address Checkbox (below title) - hidden in readonly mode -->
      @if (showSameAsPresentCheckbox && !isReadonly) {
        <div class="flex align-items-center">
          <p-checkbox
            formControlName="sameAsPresent"
            [binary]="true"
            [inputId]="'sameAsPresent_' + config.addressType">
          </p-checkbox>
          <label [for]="'sameAsPresent_' + config.addressType" class="ml-2 cursor-pointer font-semibold text-700">
            {{ sameAsCheckboxLabel }}
          </label>
        </div>
      }
    </div>

    <div class="surface-50 border-round-xl p-3">

      <!-- Row 1: Division -> District -> Upazila -> Post Office -->
      <div class="flex flex-wrap gap-3 mb-3">

        <!-- Division -->
        <div class="flex-1" style="min-width: 160px">
          <label class="font-semibold block mb-2 text-700">
            Division <span class="text-red-500">*</span>
          </label>
          <p-select
            [options]="divisions"
            formControlName="division"
            optionLabel="codeValueEN"
            optionValue="codeId"
            placeholder="Select Division"
            styleClass="w-full"
            [filter]="true"
            filterPlaceholder="Search Division"
            (onChange)="onDivisionChange($event.value)"
            >
          </p-select>
          @if (isFieldInvalid('division')) {
            <small class="text-red-500">{{ getErrorMessage('division') }}</small>
          }
        </div>

        <!-- District -->
        <div class="flex-1" style="min-width: 160px">
          <label class="font-semibold block mb-2 text-700">
            District <span class="text-red-500">*</span>
          </label>
          <p-select
            [options]="districts"
            formControlName="district"
            optionLabel="codeValueEN"
            optionValue="codeId"
            placeholder="Select District"
            styleClass="w-full"
            [filter]="true"
            filterPlaceholder="Search District"
            (onChange)="onDistrictChange($event.value)"
            [disabled]="!addressForm.get('division')?.value">
          </p-select>
          @if (isFieldInvalid('district')) {
            <small class="text-red-500">{{ getErrorMessage('district') }}</small>
          }
        </div>

        <!-- Upazila -->
        <div class="flex-1" style="min-width: 160px">
          <label class="font-semibold block mb-2 text-700">
            Upazila/Thana <span class="text-red-500">*</span>
          </label>
          <p-select
            [options]="upazilas"
            formControlName="upazila"
            optionLabel="codeValueEN"
            optionValue="codeId"
            placeholder="Select Upazila"
            styleClass="w-full"
            [filter]="true"
            filterPlaceholder="Search Upazila"
            [disabled]="!addressForm.get('district')?.value"
            (onChange)="onUpazilaChange($event.value)"
            >
          </p-select>
          @if (isFieldInvalid('upazila')) {
            <small class="text-red-500">{{ getErrorMessage('upazila') }}</small>
          }
        </div>

        <!-- Post Office -->
        <div class="flex-1" style="min-width: 170px">
          <label class="font-semibold block mb-2 text-700">
            Post Office <span class="text-red-500">*</span>
          </label>
          <div style="display: flex; align-items: center; gap: 0.35rem;">
            <div style="flex: 1; min-width: 0;">
              <p-select
                [options]="postOffices"
                formControlName="postOffice"
                optionLabel="codeValueEN"
                optionValue="codeId"
                placeholder="Select Post Office"
                styleClass="w-full"
                [filter]="true"
                filterPlaceholder="Search Post Office"
                [disabled]="!addressForm.get('upazila')?.value">
              </p-select>
            </div>
            <button
              type="button"
              pButton
              icon="pi pi-plus"
              class="p-button-sm p-button-outlined p-button-success"
              style="flex-shrink: 0; width: 2rem; height: 2rem; padding: 0;"
              pTooltip="Add New Post Office"
              tooltipPosition="top"
              (click)="openAddPostOfficeDialog()"
              [disabled]="!addressForm.get('upazila')?.value">
            </button>
          </div>
          @if (isFieldInvalid('postOffice')) {
            <small class="text-red-500">{{ getErrorMessage('postOffice') }}</small>
          }
        </div>

        <!-- Post Code -->
        <div class="flex-1" style="min-width: 120px; max-width: 160px">
          <label class="font-semibold block mb-2 text-700">
            Post Code
          </label>
          <input pInputText class="w-full" placeholder="Enter post code"
            formControlName="postCode" maxlength="10" />
          @if (isFieldInvalid('postCode')) {
            <small class="text-red-500">Max field width is 10 characters</small>
          }
        </div>

      </div>

      <!-- Row 2: Village/House -->
      <div class="flex flex-wrap gap-3">
        <div class="flex-1" style="min-width: 200px">
          <label class="font-semibold block mb-2 text-700">
            Village/Area (English)
          </label>
          <input pInputText class="w-full" placeholder="Enter village/area name in English"
            formControlName="villageEnglish" />
        </div>

        <div class="flex-1" style="min-width: 200px">
          <label class="font-semibold block mb-2 text-700">
            Village/Area (Bangla)
          </label>
          <input pInputText class="w-full" placeholder="গ্রাম/এলাকা বাংলায় লিখুন"
            formControlName="villageBangla" />
        </div>

        <div class="flex-1" style="min-width: 200px">
          <label class="font-semibold block mb-2 text-700">
            House/Road/Block/Sector
          </label>
          <input pInputText class="w-full" placeholder="Enter house number, road, block, sector"
            formControlName="houseRoad" />
        </div>
      </div>

    </div>

    <!-- Action Buttons -->
    @if (showButtons) {
      <div class="flex flex-col sm:flex-row gap-2 justify-end mt-4">
        <p-button
          type="button"
          label="Cancel"
          icon="pi pi-times"
          severity="secondary"
          [outlined]="true"
          (onClick)="handleCancel()">
        </p-button>

        <p-button
          type="button"
          label="Save {{ config.addressType }} Address"
          icon="pi pi-save"
          severity="success"
          [disabled]="addressForm.invalid"
          (onClick)="handleSave()">
        </p-button>
      </div>
    }

  </form>
</ng-template>

<!-- Add Post Office Dialog -->
<p-dialog header="Add New Post Office" [(visible)]="showPostOfficeDialog" [modal]="true" [style]="{width: '500px'}" [closable]="true" [contentStyle]="{'border-top': '2px solid var(--primary-color)'}" appendTo="body">
    <div style="display: flex; flex-direction: column; gap: 1rem;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <div>
                <label class="font-semibold block mb-2 text-700">Division</label>
                <input pInputText style="width: 100%;" [value]="getSelectedDivisionName()" [disabled]="true" />
            </div>
            <div>
                <label class="font-semibold block mb-2 text-700">District</label>
                <input pInputText style="width: 100%;" [value]="getSelectedDistrictName()" [disabled]="true" />
            </div>
            <div>
                <label class="font-semibold block mb-2 text-700">Upazila/Thana</label>
                <input pInputText style="width: 100%;" [value]="getSelectedUpazilaName()" [disabled]="true" />
            </div>
        </div>
        <div>
            <label class="font-semibold block mb-2 text-700">Post Office Name (English) <span class="text-red-500">*</span></label>
            <input pInputText style="width: 100%;" [(ngModel)]="newPostOfficeNameEN" placeholder="Enter post office name in English" />
        </div>
        <div>
            <label class="font-semibold block mb-2 text-700">Post Office Name (Bangla)</label>
            <input pInputText style="width: 100%;" [(ngModel)]="newPostOfficeNameBN" placeholder="Enter post office name in Bangla" />
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="Cancel" icon="pi pi-times" severity="secondary" [outlined]="true" (onClick)="showPostOfficeDialog = false"></p-button>
        <p-button label="Save" icon="pi pi-check" [loading]="isSavingPostOffice" [disabled]="!newPostOfficeNameEN?.trim()" (onClick)="saveNewPostOffice()"></p-button>
    </ng-template>
</p-dialog>
