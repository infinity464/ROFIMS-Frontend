<p-toast />
<p-fluid>
  <div class="card">
    <div class="font-semibold text-xl mb-4">{{ editingUser ? 'Edit User' : 'Create Identity User' }}</div>
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div class="field">
          <label for="email" class="block mb-2">Email <span class="text-red-500">*</span></label>
          <input
            pInputText
            id="email"
            type="email"
            formControlName="email"
            placeholder="user@example.com"
            class="w-full"
          />
          @if (form.get('email')?.invalid && form.get('email')?.touched) {
            <small class="text-red-500 block mt-1">
              @if (form.get('email')?.errors?.['required']) { Email is required }
              @if (form.get('email')?.errors?.['email']) { Enter a valid email }
            </small>
          }
        </div>
        <div class="field">
          <label for="phoneNumber" class="block mb-2">Phone Number</label>
          <input
            pInputText
            id="phoneNumber"
            formControlName="phoneNumber"
            placeholder="Phone"
            class="w-full"
          />
        </div>
        <div class="field">
          <label for="password" class="block mb-2">Password @if (!editingUser) { <span class="text-red-500">*</span> }</label>
          <input
            pInputText
            id="password"
            type="password"
            formControlName="password"
            [placeholder]="editingUser ? 'Leave blank to keep current' : 'Password'"
            class="w-full"
          />
          @if (form.get('password')?.invalid && form.get('password')?.touched) {
            <small class="text-red-500 block mt-1">
              At least 6 characters, 1 upper, 1 lower, 1 number and 1 symbol
            </small>
          }
        </div>
        <div class="field">
          <label for="roleName" class="block mb-2">Role <span class="text-red-500">*</span></label>
          <p-select
            id="roleName"
            formControlName="roleName"
            [options]="roles"
            optionLabel="name"
            optionValue="name"
            placeholder="Select role"
            styleClass="w-full"
          />
          @if (form.get('roleName')?.invalid && form.get('roleName')?.touched) {
            <small class="text-red-500 block mt-1">Role is required</small>
          }
        </div>
      </div>
      <div class="flex justify-end gap-2">
        <p-button
          [label]="editingUser ? 'Update User' : 'Create User'"
          type="submit"
          [loading]="isSubmitting"
          [disabled]="form.invalid || isSubmitting"
        />
        <p-button label="{{ editingUser ? 'Cancel' : 'Reset' }}" icon="pi pi-refresh" severity="secondary" type="button" (onClick)="onReset()" [disabled]="isSubmitting" />
      </div>
    </form>
  </div>

  <div class="card mt-4">
    <div class="font-semibold text-lg mb-4">User List</div>
    <p-table [value]="users" [paginator]="true" [rows]="10" [rowsPerPageOptions]="[10, 25, 50]">
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 5%">#</th>
          <th>Email</th>
          <th>User Name</th>
          <th>Phone</th>
          <th>Role</th>
          <th style="width: 10%">Action</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-user let-rowIndex="rowIndex">
        <tr>
          <td>{{ rowIndex + 1 }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.userName ?? '-' }}</td>
          <td>{{ user.phoneNumber ?? '-' }}</td>
          <td>{{ user.roleName ?? '-' }}</td>
          <td>
            <button pButton icon="pi pi-pencil" (click)="onEdit(user)" pTooltip="Edit"></button>
          </td>
        </tr>
      </ng-template>
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6">No users found.</td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</p-fluid>
