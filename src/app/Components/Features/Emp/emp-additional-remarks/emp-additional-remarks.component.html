<p-fluid>
    <div class="mb-5 card">
        <div class="flex align-items-center gap-3 mb-4">
            @if (mode !== 'search') {
                <p-button
                    icon="pi pi-arrow-left"
                    [rounded]="true"
                    [text]="true"
                    severity="secondary"
                    pTooltip="Back to List"
                    (onClick)="goBack()">
                </p-button>
            }
            <h3 class="m-0 text-xl font-bold text-900" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                Additional Remarks
            </h3>
        </div>

        @if (mode === 'search') {
            <app-employee-search
                (onEmployeeFound)="onEmployeeSearchFound($event)"
                (onSearchReset)="onEmployeeSearchReset()">
            </app-employee-search>
        }

        @if (mode !== 'search' && employeeBasicInfo) {
            <div class="surface-50 border-round-2xl p-4 mb-4">
                <div class="flex flex-wrap gap-4">
                    <div>
                        <span class="text-500 text-sm">Name:</span>
                        <span class="ml-2 font-semibold">{{ employeeBasicInfo.fullNameEN || employeeBasicInfo.FullNameEN || 'N/A' }}</span>
                    </div>
                    <div>
                        <span class="text-500 text-sm">RAB ID:</span>
                        <span class="ml-2 font-semibold">{{ employeeBasicInfo.rabid || employeeBasicInfo.Rabid || 'N/A' }}</span>
                    </div>
                    <div>
                        <span class="text-500 text-sm">Service ID:</span>
                        <span class="ml-2 font-semibold">{{ employeeBasicInfo.serviceId || employeeBasicInfo.ServiceId || 'N/A' }}</span>
                    </div>
                </div>
            </div>
        }

        @if (employeeFound) {
            @if (isLoading) {
                <div class="flex justify-content-center align-items-center p-4">
                    <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                </div>
            } @else {
                <div class="surface-50 border-round-2xl p-4 mb-4">
                    <div class="flex justify-content-between align-items-center mb-3">
                        <h4 class="m-0 text-lg font-semibold text-900">Remarks List</h4>
                        <p-button
                            label="+ Add New Remark"
                            icon="pi pi-plus"
                            (onClick)="openAddDialog()"
                            [disabled]="isReadonly">
                        </p-button>
                    </div>

                    <div class="surface-card border-round-lg overflow-hidden">
                        <p-table
                            [value]="remarksList"
                            styleClass="p-datatable-sm"
                            responsiveLayout="scroll"
                            [tableStyle]="{'min-width': '50rem'}">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th style="width: 60px; background: var(--surface-100)">Ser</th>
                                    <th style="background: var(--surface-100)">Remarks</th>
                                    <th style="width: 150px; background: var(--surface-100)">Created Date</th>
                                    <th style="width: 120px; background: var(--surface-100)">Actions</th>
                                </tr>
                            </ng-template>

                            <ng-template pTemplate="body" let-row let-i="rowIndex">
                                <tr>
                                    <td>{{ i + 1 }}</td>
                                    <td>
                                        <div style="max-width: 500px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                            {{ row.additionalRemarks || row.AdditionalRemarks || 'N/A' }}
                                        </div>
                                    </td>
                                    <td>
                                        {{ row.createdDate || row.CreatedDate ? (row.createdDate || row.CreatedDate | date:'short') : 'N/A' }}
                                    </td>
                                    <td>
                                        <div class="flex gap-2">
                                            <p-button
                                                icon="pi pi-pencil"
                                                [rounded]="true"
                                                [text]="true"
                                                severity="info"
                                                pTooltip="Edit"
                                                (onClick)="openEditDialog(row)"
                                                [disabled]="isReadonly">
                                            </p-button>
                                            <p-button
                                                icon="pi pi-trash"
                                                [rounded]="true"
                                                [text]="true"
                                                severity="danger"
                                                pTooltip="Delete"
                                                (onClick)="deleteRemark(row)"
                                                [disabled]="isReadonly">
                                            </p-button>
                                        </div>
                                    </td>
                                </tr>
                            </ng-template>

                            <ng-template pTemplate="emptymessage">
                                <tr>
                                    <td colspan="4" class="text-center p-4 text-600">
                                        <i class="pi pi-info-circle mr-2"></i>
                                        No remarks found. Click "Add New Remark" to add one.
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </div>

                <div class="flex justify-end mt-4 gap-2">
                    <p-button
                        label="Reset"
                        icon="pi pi-refresh"
                        severity="secondary"
                        [outlined]="true"
                        (onClick)="resetForm()">
                    </p-button>
                    <p-button
                        label="Back to List"
                        icon="pi pi-arrow-left"
                        severity="secondary"
                        [outlined]="true"
                        (onClick)="goBack()">
                    </p-button>
                </div>
            }
        }
    </div>

    <!-- Add/Edit Dialog -->
    <p-dialog
        [(visible)]="displayDialog"
        [header]="isEditMode ? 'Edit Remark' : 'Add New Remark'"
        [modal]="true"
        [style]="{width: '600px'}"
        [draggable]="false"
        [resizable]="false">
        <form [formGroup]="remarksForm" class="flex flex-column gap-3">
            <div class="field">
                <label class="font-semibold block mb-2 text-700">Additional Remarks <span class="text-red-500">*</span></label>
                <textarea
                    pTextarea
                    formControlName="additionalRemarks"
                    [rows]="6"
                    placeholder="Enter additional remarks about the employee..."
                    class="w-full"
                    style="resize: vertical; min-height: 120px;">
                </textarea>
                @if (remarksForm.get('additionalRemarks')?.invalid && remarksForm.get('additionalRemarks')?.touched) {
                    <small class="p-error">Remarks is required</small>
                }
            </div>
        </form>
        <ng-template pTemplate="footer">
            <div class="flex justify-end gap-2">
                <p-button
                    label="Cancel"
                    icon="pi pi-times"
                    severity="secondary"
                    [outlined]="true"
                    (onClick)="closeDialog()"
                    [disabled]="isSaving">
                </p-button>
                <p-button
                    [label]="isEditMode ? 'Update' : 'Save'"
                    icon="pi pi-check"
                    (onClick)="saveRemark()"
                    [disabled]="isSaving || remarksForm.invalid"
                    [loading]="isSaving">
                </p-button>
            </div>
        </ng-template>
    </p-dialog>

    <p-confirmDialog></p-confirmDialog>
</p-fluid>
