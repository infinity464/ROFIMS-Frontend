<p-fluid>
    <div class="mb-5 card">
        <div class="flex align-items-center gap-3 mb-4">
            @if (mode !== 'search') {
                <p-button
                    icon="pi pi-arrow-left"
                    [rounded]="true"
                    [text]="true"
                    severity="secondary"
                    pTooltip="Back to List"
                    (onClick)="goBack()">
                </p-button>
            }
            <h3 class="m-0 text-xl font-bold text-900" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                Additional Remarks
            </h3>
        </div>

        @if (mode === 'search') {
            <app-employee-search
                (onEmployeeFound)="onEmployeeSearchFound($event)"
                (onSearchReset)="onEmployeeSearchReset()">
            </app-employee-search>
        }

        @if (mode !== 'search' && employeeBasicInfo) {
            <div class="surface-50 border-round-2xl p-4 mb-4">
                <div class="flex flex-wrap gap-4">
                    <div>
                        <span class="text-500 text-sm">Name:</span>
                        <span class="ml-2 font-semibold">{{ employeeBasicInfo.fullNameEN || employeeBasicInfo.FullNameEN || 'N/A' }}</span>
                    </div>
                    <div>
                        <span class="text-500 text-sm">RAB ID:</span>
                        <span class="ml-2 font-semibold">{{ employeeBasicInfo.rabid || employeeBasicInfo.Rabid || 'N/A' }}</span>
                    </div>
                    <div>
                        <span class="text-500 text-sm">Service ID:</span>
                        <span class="ml-2 font-semibold">{{ employeeBasicInfo.serviceId || employeeBasicInfo.ServiceId || 'N/A' }}</span>
                    </div>
                </div>
            </div>
        }

        @if (employeeFound) {
            @if (isLoading) {
                <div class="flex justify-content-center align-items-center p-4">
                    <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
                </div>
            } @else {
                <div class="surface-card border-round p-4 mb-4">
                    <div class="flex justify-content-between align-items-center gap-3 mb-3 flex-wrap">
                        <h4 class="m-0 text-lg font-semibold text-900 white-space-nowrap">Remarks List</h4>
                        <p-button
                            label="Add New Remark"
                            icon="pi pi-plus"
                            (onClick)="openAddDialog()"
                            [disabled]="isReadonly">
                        </p-button>
                    </div>

                    <p-table
                        [value]="remarksList"
                        [loading]="isLoading"
                        [tableStyle]="{'min-width': '60rem'}"
                        styleClass="p-datatable-sm">
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width: 60px;">Ser</th>
                                <th>Remarks</th>
                                <th style="width: 160px;">Created Date</th>
                                <th style="width: 130px;">Actions</th>
                            </tr>
                        </ng-template>

                        <ng-template pTemplate="body" let-row let-i="rowIndex">
                            <tr>
                                <td>{{ i + 1 }}</td>
                                <td [title]="row.additionalRemarks || row.AdditionalRemarks || 'N/A'">
                                    <span class="text-700">{{ row.additionalRemarks || row.AdditionalRemarks || 'N/A' }}</span>
                                </td>
                                <td>
                                    <span class="text-600 text-sm">
                                        {{ row.createdDate || row.CreatedDate ? (row.createdDate || row.CreatedDate | date:'MMM d, y h:mm a') : 'N/A' }}
                                    </span>
                                </td>
                                <td>
                                    <div class="flex gap-2">
                                        <p-button
                                            icon="pi pi-pencil"
                                            [rounded]="true"
                                            [text]="true"
                                            severity="info"
                                            pTooltip="Edit"
                                            pTooltipPosition="top"
                                            (onClick)="openEditDialog(row)"
                                            [disabled]="isReadonly">
                                        </p-button>
                                        <p-button
                                            icon="pi pi-trash"
                                            [rounded]="true"
                                            [text]="true"
                                            severity="danger"
                                            pTooltip="Delete"
                                            pTooltipPosition="top"
                                            (onClick)="confirmDeleteRemark(row)"
                                            [disabled]="isReadonly">
                                        </p-button>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>

                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="4" class="text-center py-4">
                                    <p class="text-500 m-0">
                                        <i class="pi pi-inbox mr-2"></i>
                                        No remarks found. Click "Add New Remark" to add one.
                                    </p>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>

                <div class="flex justify-end mt-4 gap-2">
                    <p-button
                        label="Reset"
                        icon="pi pi-refresh"
                        severity="secondary"
                        [outlined]="true"
                        (onClick)="resetForm()">
                    </p-button>
                    <p-button
                        label="Back to List"
                        icon="pi pi-arrow-left"
                        severity="secondary"
                        [outlined]="true"
                        (onClick)="goBack()">
                    </p-button>
                </div>
            }
        }
    </div>

    <!-- Add/Edit Remark Dialog -->
    <p-dialog
        [(visible)]="displayDialog"
        [header]="isEditMode ? 'Edit Remark' : 'Add New Remark'"
        [modal]="true"
        [style]="{width: '500px'}"
        [closable]="true">
        <form [formGroup]="remarksForm">
            <label class="font-semibold block mb-2 text-700">Additional Remarks <span class="text-red-500">*</span></label>
            <textarea
                pTextarea
                formControlName="additionalRemarks"
                [rows]="5"
                placeholder="Enter additional remarks..."
                class="w-full"
                [class.ng-invalid]="remarksForm.get('additionalRemarks')?.invalid && remarksForm.get('additionalRemarks')?.touched"
                style="resize: none;">
            </textarea>
            @if (remarksForm.get('additionalRemarks')?.invalid && remarksForm.get('additionalRemarks')?.touched) {
                <small class="text-red-500 block mt-2">Remarks is required</small>
            }
        </form>
        <ng-template pTemplate="footer">
            <p-button
                label="Cancel"
                icon="pi pi-times"
                severity="secondary"
                [outlined]="true"
                (onClick)="closeDialog()"
                [disabled]="isSaving">
            </p-button>
            <p-button
                [label]="isEditMode ? 'Update' : 'Save'"
                icon="pi pi-check"
                (onClick)="saveRemark()"
                [disabled]="isSaving || remarksForm.invalid"
                [loading]="isSaving">
            </p-button>
        </ng-template>
    </p-dialog>

    <p-confirmDialog></p-confirmDialog>
</p-fluid>
