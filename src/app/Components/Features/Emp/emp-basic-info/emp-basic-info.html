<p-fluid>
    <div class="mb-5 card">
        <div class="flex align-items-center gap-3 mb-4">
            <h3 class="m-0 text-xl font-bold text-900">New Posting Entry Form</h3>
            <!-- Show generated EmployeeID -->
            @if (generatedEmployeeId) {
                <div class="flex align-items-center gap-2">
                    <span class="text-500 text-sm">Employee ID:</span>
                    <span class="surface-200 border-round px-2 py-1 text-sm font-semibold text-primary">{{ generatedEmployeeId }}</span>
                </div>
            }
        </div>

        <form [formGroup]="postingForm" (ngSubmit)="onSubmit()">
            <div class="surface-50 border-round-2xl p-4">
                <!-- Row 1: 4 Fields -->
                <div class="flex flex-wrap gap-3 mb-4">
                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">Add Picture</label>

                        <!-- Image Preview -->
                        @if (imagePreview) {
                        <div class="mb-3 relative">
                            <img [src]="imagePreview" alt="Profile Picture" class="w-full border-round"
                                style="max-height: 200px; object-fit: cover;" />
                            <button pButton type="button" icon="pi pi-times"
                                class="p-button-rounded p-button-danger p-button-sm absolute"
                                style="top: 8px; right: 8px;" (click)="removeImage()" pTooltip="Remove Image">
                            </button>
                        </div>
                        }

                        <p-fileUpload #fileUpload mode="basic" chooseLabel="Upload Picture" chooseIcon="pi pi-upload"
                            name="picture" accept="image/*" [auto]="true" (onSelect)="onFileSelect($event)"
                            maxFileSize="5000000" styleClass="w-full">
                        </p-fileUpload>
                        <small class="text-500">Max size: 5MB (JPG, PNG, GIF)</small>
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Mother Organization <span class="text-red-500">*</span>
                        </label>
                        <p-select [options]="motherOrganizations" formControlName="motherOrganization"
                            optionLabel="orgNameEN" optionValue="orgId" placeholder="Select Mother Organization"
                            styleClass="w-full" (onChange)="onMotherOrgChange($event.value)"
                            [filter]="true" filterPlaceholder="Search">
                        </p-select>
                        @if (isFieldInvalid('motherOrganization')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('motherOrganization') }}
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Last Unit of Mother Organization <span class="text-red-500">*</span>
                        </label>
                        <p-select [options]="lastUnitOrganizations" optionLabel="orgNameEN" optionValue="orgId"
                            placeholder="Select Last Unit" styleClass="w-full" formControlName="lastMotherUnit"
                            (onChange)="onLastUnitChange($event.value)"
                            [filter]="true" filterPlaceholder="Search">
                        </p-select>
                        @if (isFieldInvalid('lastMotherUnit')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('lastMotherUnit') }}
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Last Mother Unit Location <span class="text-red-500">*</span>
                        </label>
                        <input pInputText class="w-full" placeholder="Manual Entry / Auto Select"
                            formControlName="lastMotherUnitLocation" readonly />
                        @if (isFieldInvalid('lastMotherUnitLocation')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('lastMotherUnitLocation') }}
                        </small>
                        }
                    </div>
                </div>

                <!-- Row 2: 4 Fields -->
                <div class="flex flex-wrap gap-3 mb-4">
                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Member Type <span class="text-red-500">*</span>
                        </label>
                        <p-select [options]="memberTypes" optionLabel="codeValueEN" optionValue="codeId"
                            placeholder="Select Member Type" styleClass="w-full" formControlName="memberType"
                            (onChange)="onMemberTypeChange($event.value)"
                            [filter]="true" filterPlaceholder="Search">
                        </p-select>
                        @if (isFieldInvalid('memberType')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('memberType') }}
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Officer Type <span class="text-red-500">*</span>
                        </label>
                        <p-select [options]="officerTypes" optionLabel="codeValueEN" optionValue="codeId"
                            placeholder="Select Officer Type" styleClass="w-full" formControlName="officerType"
                            [filter]="true" filterPlaceholder="Search">
                        </p-select>
                        @if (isFieldInvalid('officerType')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('officerType') }}
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Appointment <span class="text-red-500">*</span>
                        </label>
                        <p-select [options]="appointments" optionLabel="codeValueEN" optionValue="codeId"
                            placeholder="Select Appointment" styleClass="w-full" formControlName="appointment"
                            [filter]="true" filterPlaceholder="Search">
                        </p-select>
                        @if (isFieldInvalid('appointment')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('appointment') }}
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Date of Joining in RAB <span class="text-red-500">*</span>
                        </label>
                        <p-datepicker formControlName="joiningDate" dateFormat="dd-mm-yy" placeholder="Select Date"
                            styleClass="w-full">
                        </p-datepicker>
                        @if (isFieldInvalid('joiningDate')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('joiningDate') }}
                        </small>
                        }
                    </div>
                </div>

                <!-- Row 3: 4 Fields -->
                <div class="flex flex-wrap gap-3 mb-4">
                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Rank <span class="text-red-500">*</span>
                        </label>
                        <p-select [options]="ranks" optionLabel="codeValueEN" optionValue="codeId"
                            placeholder="Select Rank" styleClass="w-full" formControlName="rank"
                            [filter]="true" filterPlaceholder="Search">
                        </p-select>
                        @if (isFieldInvalid('rank')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('rank') }}
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Corps <span class="text-red-500">*</span>
                        </label>
                        <p-select [options]="corps" optionLabel="codeValueEN" optionValue="codeId"
                            placeholder="Select Corps" styleClass="w-full" formControlName="branch"
                            (onChange)="onChangeCorps($event.value)"
                            [filter]="true" filterPlaceholder="Search">
                        </p-select>
                        @if (isFieldInvalid('branch')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('branch') }}
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Trade <span class="text-red-500">*</span>
                        </label>
                        <p-select [options]="trades" optionLabel="codeValueEN" optionValue="codeId"
                            placeholder="Select Trade" styleClass="w-full" formControlName="trade"
                            [filter]="true" filterPlaceholder="Search">
                        </p-select>
                        @if (isFieldInvalid('trade')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('trade') }}
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">Trade Remarks</label>
                        <input pInputText class="w-full" placeholder="Enter remarks" formControlName="tradeMark" />
                    </div>
                </div>

                <!-- Row 4: 4 Fields -->
                <div class="flex flex-wrap gap-3 mb-4">
                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Gender <span class="text-red-500">*</span>
                        </label>
                        <p-select [options]="genders" optionLabel="codeValueEN" optionValue="codeId"
                            placeholder="Select Gender" styleClass="w-full" formControlName="gender"
                            [filter]="true" filterPlaceholder="Search">
                        </p-select>
                        @if (isFieldInvalid('gender')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('gender') }}
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Select Prefix <span class="text-red-500">*</span>
                        </label>
                        <p-select [options]="prefixes" optionLabel="codeValueEN" optionValue="codeId"
                            placeholder="Select Prefix" styleClass="w-full" formControlName="prefix"
                            [filter]="true" filterPlaceholder="Search">
                        </p-select>
                        @if (isFieldInvalid('prefix')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('prefix') }}
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Service ID <span class="text-red-500">*</span>
                        </label>
                        <div class="p-inputgroup">
                            <input pInputText class="w-full" placeholder="Only Number" formControlName="serviceId"
                                (blur)="checkServiceIdDuplicate($event.target.value)" />
                            @if (isCheckingServiceId) {
                                <span class="p-inputgroup-addon">
                                    <i class="pi pi-spin pi-spinner"></i>
                                </span>
                            }
                        </div>
                        @if (isFieldInvalid('serviceId')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('serviceId') }}
                        </small>
                        }
                        @if (isServiceIdDuplicate) {
                        <small class="text-red-500">
                            This Service ID already exists in the system
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">RAB ID</label>
                        <input pInputText class="w-full surface-100" placeholder="Auto Generated"
                            formControlName="rabid" readonly />
                    </div>
                </div>

                <!-- Row 5: Name English, Name Bangla -->
                <div class="flex flex-wrap gap-3 mb-4">
                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Name English <span class="text-red-500">*</span>
                        </label>
                        <input pInputText class="w-full" placeholder="Enter name in English"
                            formControlName="fullNameEN" />
                        @if (isFieldInvalid('fullNameEN')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('fullNameEN') }}
                        </small>
                        }
                    </div>

                    <div class="flex-1" style="min-width: 200px">
                        <label class="font-semibold block mb-2 text-700">
                            Name Bangla <span class="text-red-500">*</span>
                        </label>
                        <input pInputText class="w-full" placeholder="বাংলায় নাম লিখুন" formControlName="fullNameBN" />
                        @if (isFieldInvalid('fullNameBN')) {
                        <small class="text-red-500">
                            {{ getErrorMessage('fullNameBN') }}
                        </small>
                        }
                    </div>
                </div>
            </div>


            <div class="flex flex-col sm:flex-row gap-2 justify-end">
                <p-button type="submit" label="Save" [disabled]="postingForm.invalid || isServiceIdDuplicate || isCheckingServiceId"
                    [fluid]="false"></p-button>

            </div>
        </form>
    </div>

    <!-- Permanent Address Section -->
    <app-address-form
      [config]="permanentAddressConfig"
      [savedAddressId]="permanentAddressId"
      (onSave)="savePermanentAddress($event)"
      (onCancel)="cancelAddress()">
    </app-address-form>

    <!-- Present Address Section -->
    <app-address-form
      [config]="presentAddressConfig"
      [presentAddressData]="permanentAddress"
      [savedAddressId]="presentAddressId"
      (onSave)="savePresentAddress($event)"
      (onCancel)="cancelAddress()">
    </app-address-form>

    <!-- Wife Permanent Address Section -->
    <app-address-form
      [config]="wifePermanentAddressConfig"
      [savedAddressId]="wifePermanentAddressId"
      (onSave)="saveWifePermanentAddress($event)"
      (onCancel)="cancelAddress()">
    </app-address-form>

    <!-- Wife Present Address Section -->
    <app-address-form
      [config]="wifePresentAddressConfig"
      [presentAddressData]="wifePermanentAddress"
      [savedAddressId]="wifePresentAddressId"
      (onSave)="saveWifePresentAddress($event)"
      (onCancel)="cancelAddress()">
    </app-address-form>

    <!-- Reliever Section -->
    <div class="mb-5 card">
        <div class="mb-4">
            <h3 class="m-0 text-xl font-bold text-900 mb-3">Reliever Information</h3>
        </div>

        <div class="surface-50 border-round-2xl p-4">
            <!-- Checkbox: Is he a reliever? -->
            <div class="flex align-items-center gap-2 mb-4">
                <p-checkbox
                    [(ngModel)]="isReliever"
                    [binary]="true"
                    inputId="isReliever"
                    (onChange)="onRelieverCheckChange($event.checked)">
                </p-checkbox>
                <label for="isReliever" class="cursor-pointer font-semibold text-700">
                    Is he a reliever of any presently serving member?
                </label>
            </div>

            <!-- Show dropdown if checked -->
            @if (isReliever) {
                <div class="flex flex-wrap gap-3 mb-4">
                    <div class="flex-1" style="min-width: 300px; max-width: 400px;">
                        <label class="font-semibold block mb-2 text-700">
                            Select Presently Serving Member <span class="text-red-500">*</span>
                        </label>
                        <p-select
                            [options]="existingEmployees"
                            [(ngModel)]="selectedRelieverEmployeeId"
                            optionLabel="fullNameEN"
                            optionValue="employeeID"
                            placeholder="Search by RAB ID / Service ID / Name"
                            styleClass="w-full"
                            [filter]="true"
                            filterPlaceholder="Search employee..."
                            (onChange)="onRelieverEmployeeSelect($event.value)">
                            <ng-template let-emp pTemplate="item">
                                <div class="flex flex-column">
                                    <span class="font-semibold">{{ emp.fullNameEN }}</span>
                                    <small class="text-500">Service ID: {{ emp.serviceId }} | RAB ID: {{ emp.rabid }}</small>
                                </div>
                            </ng-template>
                        </p-select>
                    </div>
                </div>

                <!-- Show selected employee details -->
                @if (selectedRelieverEmployee) {
                    <div class="surface-100 border-round p-3 mb-4">
                        <h4 class="m-0 mb-2 text-700">Selected Member Details</h4>
                        <div class="flex flex-wrap gap-4">
                            <div>
                                <span class="text-500 text-sm">Service ID:</span>
                                <span class="ml-2 font-semibold">{{ selectedRelieverEmployee.serviceId }}</span>
                            </div>
                            <div>
                                <span class="text-500 text-sm">RAB ID:</span>
                                <span class="ml-2 font-semibold">{{ selectedRelieverEmployee.rabid || 'N/A' }}</span>
                            </div>
                            <div>
                                <span class="text-500 text-sm">Name:</span>
                                <span class="ml-2 font-semibold">{{ selectedRelieverEmployee.fullNameEN }}</span>
                            </div>
                            <div>
                                <span class="text-500 text-sm">Rank:</span>
                                <span class="ml-2 font-semibold">{{ selectedRelieverEmployee.rank || 'N/A' }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Update Button -->
                    <div class="flex justify-end">
                        <p-button
                            type="button"
                            label="Update Reliever Info"
                            icon="pi pi-save"
                            severity="success"
                            (onClick)="updateRelieverId()">
                        </p-button>
                    </div>
                }
            }
        </div>
    </div>
</p-fluid>
